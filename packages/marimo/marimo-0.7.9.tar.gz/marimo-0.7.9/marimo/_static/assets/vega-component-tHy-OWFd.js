import{gF as e,b as t,j as n,eX as r,aQ as a,r as i,gG as o,aq as c,c5 as s,gH as l,gI as p,b8 as u,a6 as m,aW as d}from"./index-DSnDx_mo.js";import{M as f,V as g}from"./VegaLite-Bt-sikgM.js";import{a as y}from"./url-DfsnS7JZ.js";import"./time-CPVooapV.js";import"./timer-Di1g2zcK.js";import"./linear-BTPJypyu.js";import"./init-DLRA0X12.js";import"./range-CtcPcB_L.js";import"./zoom-COrs4lFh.js";import"./ordinal-DDUp3AbE.js";import"./arc-CyWW4RED.js";import"./path-qnb_ma6O.js";import"./step-CPXY0cSE.js";import"./array-DmjLdZ15.js";import"./line-BfNOlI_-.js";import"./index-BWOs3XYA.js";const h={getMarkType(e){const t="string"==typeof e?e:e.type;if("boxplot"===t||"errorband"===t||"errorbar"===t)throw new Error("Not supported");return t},makeClickable(e){const t="string"==typeof e?e:e.type;return t in f?"string"==typeof e?{type:e,cursor:"pointer",tooltip:!0}:{...e,type:t,cursor:"pointer",tooltip:!0}:e},getOpacity:e=>"string"==typeof e?null:"opacity"in e&&"number"==typeof e.opacity?e.opacity:null};const v=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function j(e,t,n,r){const a={and:n.map((e=>({param:e})))};if("opacity"===e){const e=h.getOpacity(r)||1;return{...t,opacity:{condition:{test:a,value:e},value:e/5}}}return t}const k={point:e=>null==e?"select_point":`select_point_${e}`,interval:e=>null==e?"select_interval":`select_interval_${e}`,legendSelection:e=>`legend_selection_${e}`,HIGHLIGHT:"highlight"},x={highlight:()=>({name:k.HIGHLIGHT,select:{type:"point",on:"mouseover"}}),interval:(e,t)=>({name:k.interval(t),select:{type:"interval",encodings:b(e),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4}}}),point:(e,t)=>({name:k.point(t),select:{type:"point",encodings:b(e)}}),legend:e=>({name:k.legendSelection(e),select:{type:"point",fields:[e]},bind:"legend"})};function b(e){switch(h.getMarkType(e.mark)){case f.image:case f.trail:return;case f.area:case f.arc:return["color"];case f.bar:{const t=function(e){var t,n;if(!e||!("mark"in e))return;const r=null==(t=e.encoding)?void 0:t.x,a=null==(n=e.encoding)?void 0:n.y;if(r&&"type"in r&&"nominal"===r.type)return"vertical";if(a&&"type"in a&&"nominal"===a.type)return"horizontal";if(r&&"aggregate"in r)return"horizontal";if(a&&"aggregate"in a)return"vertical";return}(e);return"horizontal"===t?["y"]:"vertical"===t?["x"]:void 0}case f.circle:case f.geoshape:case f.line:case f.point:case f.rect:case f.rule:case f.square:case f.text:case f.tick:return["x","y"]}}function S(e){if("params"in e&&e.params&&e.params.length>0){return e.params.filter((e=>null!=e&&("select"in e&&void 0!==e.select))).map((e=>e.name))}return"layer"in e?[...new Set(e.layer.flatMap(S))]:[]}function w(e,t){const{chartSelection:n=!0,fieldSelection:r=!0}=t;if(!n&&!r)return e;if("vconcat"in e){const t=e.vconcat.map((e=>"mark"in e?V(e):e));return{...e,vconcat:t}}if("hconcat"in e){const t=e.hconcat.map((e=>"mark"in e?V(e):e));return{...e,hconcat:t}}if("layer"in e){const t=e.layer.map(((e,t)=>{if(!("mark"in e))return e;let r=e;return r=M(r,n,t),r=V(r),r}));return{...e,layer:t}}if(!("mark"in e))return e;let a=e;return a=function(e,t){if(!1===t)return e;let n=function(e){if(!e||!("encoding"in e))return[];const{encoding:t}=e;return t?Object.entries(t).flatMap((e=>{const[t,n]=e;return n&&v.has(t)?"field"in n&&"string"==typeof n.field?[n.field]:"condition"in n&&n.condition&&"object"==typeof n.condition&&"field"in n.condition&&n.condition.field&&"string"==typeof n.condition.field?[n.condition.field]:[]:[]})):[]}(e);Array.isArray(t)&&(n=n.filter((e=>t.includes(e))));const r=n.map((e=>x.legend(e))),a=[...e.params||[],...r];return{...e,params:a}}(a,r),a=M(a,n,void 0),a=V(a),a}function M(e,t,n){if(!1===t)return e;let r;try{r=h.getMarkType(e.mark)}catch{return e}if("text"===r)return e;const a=!0===t?function(e){switch(e){case"text":case"arc":case"area":return["point"];case"bar":default:return["point","interval"];case"line":return}}(r):[t];if(!a)return e;const i=a.map((t=>"interval"===t?x.interval(e,n):x.point(e,n))),o=[...e.params||[],...i];return{...e,params:o}}function V(e){const t="encoding"in e?e.encoding:void 0,n=e.params||[],r=n.map((e=>e.name));if(0===n.length)return e;return"text"===h.getMarkType(e.mark)?e:{...e,mark:h.makeClickable(e.mark),encoding:j("opacity",t||{},r,e.mark)}}const _=({value:a,setValue:i,chartSelection:o,fieldSelection:c,spec:s})=>{const{data:l,error:p}=t((async()=>async function(t){if(!t)return t;const n="datasets"in t?{...t.datasets}:{},r=async t=>{if(!t)return t;if("layer"in t){const e=await Promise.all(t.layer.map(r));t={...t,layer:e}}if("hconcat"in t){const e=await Promise.all(t.hconcat.map(r));t={...t,hconcat:e}}if("vconcat"in t){const e=await Promise.all(t.vconcat.map(r));t={...t,vconcat:e}}if(!t.data)return t;if(!("url"in t.data))return t;let a;try{a=y(t.data.url)}catch{return t}const i=await e(a.href,t.data.format);return n[a.pathname]=i,{...t,data:{name:a.pathname}}},a=await r(t);return 0===Object.keys(n).length?a:{...a,datasets:n}}(s)),[s]);return p?n.jsx(r,{error:p}):l?n.jsx(H,{value:a,setValue:i,chartSelection:o,fieldSelection:c,spec:l}):null},H=({value:e,setValue:t,chartSelection:r,fieldSelection:f,spec:h})=>{const{theme:v}=a(),j=i.useRef(),[k,x]=i.useState(),b=i.useMemo((()=>w(function(e){return e.data&&"url"in e.data&&(e.data.url=y(e.data.url).href),e}(h),{chartSelection:r,fieldSelection:f})),[o(h),r,f]),M=i.useMemo((()=>S(b)),[b]),V=c((n=>{t({...e,...n})})),_=i.useMemo((()=>M.reduce(((e,t)=>(e[t]=s(((e,t)=>{m.debug("[Vega signal]",e,t),V({[e]:d.mapValues(t,F)})}),100),e)),{})),[o(M),t]),H=c((e=>{m.error(e),m.debug(b),x(e)})),T=c((e=>{m.debug("[Vega view] created",e),j.current=e,x(void 0)}));return n.jsxs(n.Fragment,{children:[k&&n.jsxs(l,{variant:"destructive",children:[n.jsx(p,{children:k.message}),n.jsx("div",{className:"text-md",children:k.stack})]}),n.jsx("div",{className:"contents",onPointerDown:u.stopPropagation(),children:n.jsx(g,{spec:b,theme:"dark"===v?"dark":void 0,actions:O,signalListeners:_,onError:H,onNewView:T})})]})},O={source:!1,compiled:!1};function F(e){return e instanceof Set?[...e]:e}export{_ as default};
