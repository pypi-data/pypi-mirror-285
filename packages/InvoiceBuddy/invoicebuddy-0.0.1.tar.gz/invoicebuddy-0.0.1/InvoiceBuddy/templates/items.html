{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Items (<span id="items-count-header"></span>)</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="items-data-table">
            <thead class="thead-light">
            <tr>
                <th scope="col">Title</th>
                <th scope="col">Description</th>
                <th scope="col">Price</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody id="items-data-table-body">

            </tbody>
        </table>
    </div>
    <nav class="d-flex justify-content-center" aria-label="Page navigation">
        <ul class="pagination" id="pagination">
            <!-- Pagination links will be populated here -->
        </ul>
    </nav>
</div>

<script type="text/javascript">
function refreshData(page) {
    $.ajax({
        type: 'GET',
        url: '/items?page=' + page,
        success: function(data) {
            // Populate past invoices section
            const itemsDataTable = document.getElementById('items-data-table').getElementsByTagName('tbody')[0];
            const tableBody = $('#items-data-table-body');
            const pagination = $('#pagination');

            // clear all the old rows first
            tableBody.empty();

            // Repopulate the table
            for (const [entry, values] of Object.entries(data['items'])) {
                    const row = itemsDataTable.insertRow();

                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    const cell3 = row.insertCell(2);
                    const cell4 = row.insertCell(3);

                    cell1.innerHTML = values.title;
                    cell2.innerHTML = values.description;
                    cell3.innerHTML = values.price + ' {{ currency_name }}';
                    cell4.innerHTML = `<button type="button" class="btn btn-danger delete-item-button me-1" data-id="${values.id}"><i class="bi bi-trash"></i></button>`;
            }

            // Handle view invoice button clicks
            $('.delete-item-button').on('click', function () {
                const item_id = $(this).data('id');

                // Delete the item with the specified ID
                deleteItemWithID(item_id);
            });

            pagination.empty();
            for (let i = 1; i <= parseInt(data['total_number_of_pages']); i++) {
                let li = `<li class="page-item ${i === page ? 'highlighted' : ''}">`;
                li += `<a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                pagination.append(li);
            }

            // Handle pagination click
            pagination.on('click', 'a', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                refreshData(page);
            });

            $('#items-count').html(parseInt(data['total_number_of_items']));
            $('#items-count-header').html(parseInt(data['total_number_of_items']));
        }
    });

    $.ajax({
        url: '/past_invoices_count',
        method: 'GET',
        success: function(response) {
            $('#past_invoices_count').text(String(response));
        },
        error: function (error) {
            $('#loading_modal').modal('hide');
            notify_warning('Error while trying to retrieve past invoices count! Reason: ' + error);
        }
    });

    $.ajax({
        url: '/past_proposals_count',
        method: 'GET',
        success: function(response) {
            $('#past_proposals_count').text(String(response));
        },
        error: function (error) {
            $('#loading_modal').modal('hide');
            notify_warning('Error while trying to retrieve past proposals count! Reason: ' + error);
        }
    });

    // hide the loading modal
    $('#loading_modal').modal('hide');
}

$(document).ready(function() {
    $('#loading_modal').modal('show');

    setTimeout(() => {
        refreshData(1);
    }, 500);
});

function deleteItemWithID(itemID) {
    $('#loading_modal').modal('show');

    $.ajax({
        url: '/delete_item',
        method: 'POST',
        data: {
            item_id: itemID
        },
        success: function(response) {
            // hide the loading modal
            $('#loading_modal').modal('hide');

            refreshData(1);
        },
        error: function (error) {
            $('#loading_modal').modal('hide');
            notify_warning('Error while trying to delete the specified item! Reason: ' + error);
        }
    });
}
</script>

{% endblock %}