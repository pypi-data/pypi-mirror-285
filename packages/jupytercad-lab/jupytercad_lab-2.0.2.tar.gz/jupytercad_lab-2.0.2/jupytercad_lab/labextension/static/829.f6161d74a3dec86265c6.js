"use strict";(self.webpackChunk_jupytercad_jupytercad_lab=self.webpackChunk_jupytercad_jupytercad_lab||[]).push([[829],{829:(e,t,s)=>{s.r(t),s.d(t,{IJupyterYWidgetManager:()=>l,JupyterYDoc:()=>d,JupyterYModel:()=>n,default:()=>B,notebookRenderer:()=>V,yWidgetManager:()=>q});var r=s(262),i=s(602),o=s(206);class n{constructor(e){this._isDisposed=!1,this._disposed=new i.Signal(this),this._yModelName=e.ymodel_name;const t=this.ydocFactory(e);this._sharedModel=new d(e,t)}get yModelName(){return this._yModelName}get sharedModel(){return this._sharedModel}get sharedAttrsChanged(){return this.sharedModel.attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}ydocFactory(e){return new o.Doc}dispose(){this._isDisposed||(this._isDisposed=!0,this._sharedModel.dispose(),this._disposed.emit(),i.Signal.clearData(this))}addAttr(e,t){this.sharedModel.setAttr(e,t)}removeAttr(e){this.sharedModel.removeAttr(e)}}class d{constructor(e,t){this._attrsObserver=e=>{this._attrsChanged.emit(e.keys)},this._attrsChanged=new i.Signal(this),this._isDisposed=!1,this._disposed=new i.Signal(this),this._commMetadata=e,this._ydoc=t,e.create_ydoc&&(this._attrs=this._ydoc.getMap("_attrs"),this._attrs.observe(this._attrsObserver))}get commMetadata(){return this._commMetadata}get ydoc(){return this._ydoc}get attrs(){return r.JSONExt.deepCopy(this._attrs.toJSON())}get attrsChanged(){return this._attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._attrs.unobserve(this._attrsObserver),this._disposed.emit(),i.Signal.clearData(this),this._isDisposed=!0)}getAttr(e){return this._attrs.get(e)}setAttr(e,t){this._attrs.set(e,t)}removeAttr(e){this._attrs.has(e)&&this._attrs.delete(e)}}var a=s(31),c=s(275);class h{constructor(e){this._isDisposed=!1,this._widgetManager=e.widgetManager,this._kernelId=e.kernelId}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._isDisposed=!0)}getYModel(e){if(this._kernelId)return this._widgetManager.getWidgetModel(this._kernelId,e)}createYWidget(e,t){if(this._kernelId){const s=this._widgetManager.getWidgetModel(this._kernelId,e);s&&new(this._widgetManager.getWidgetFactory(s.yModelName))(s,t)}}}const l=new r.Token("yjs-widgets:IJupyterYWidgetManager","A manager of Yjs-based Jupyter widgets.");var g=s(256);class u extends g.Widget{constructor(e){super(),this._modelFactory=e.modelFactory,this._mimeType=e.mimeType,this.addClass("mimerenderer-jupyterywidget")}dispose(){var e;this.isDisposed||(null===(e=this._yModel)||void 0===e||e.dispose(),super.dispose())}async renderModel(e){const t=e.data[this._mimeType].model_id;this._yModel=this._modelFactory.getYModel(t),this._yModel&&this._modelFactory.createYWidget(t,this.node)}}const _=127,y=Math.floor,p=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,Number.isNaN,Math.pow,Math.sign,Number.MAX_SAFE_INTEGER),m=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,String.fromCharCode),M=(String.fromCodePoint,m(65535),"undefined"!=typeof TextEncoder?new TextEncoder:null);let f="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});f&&1===f.decode(new Uint8Array).length&&(f=null);const w=e=>new Error(e),b=w("Unexpected end of array"),v=w("Integer out of Range");class C{constructor(e){this.arr=e,this.pos=0}}const A=e=>((e,t)=>{const s=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,s})(e,N(e)),N=e=>{let t=0,s=1;const r=e.arr.length;for(;e.pos<r;){const r=e.arr[e.pos++];if(t+=(r&_)*s,s*=128,r<128)return t;if(t>p)throw v}throw b};class k{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const D=()=>new k,S=e=>{let t=e.cpos;for(let s=0;s<e.bufs.length;s++)t+=e.bufs[s].length;return t},F=e=>{const t=new Uint8Array(S(e));let s=0;for(let r=0;r<e.bufs.length;r++){const i=e.bufs[r];t.set(i,s),s+=i.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),s),t},I=(e,t)=>{const s=e.cbuf.length;e.cpos===s&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*s),e.cpos=0),e.cbuf[e.cpos++]=t},W=(e,t)=>{for(;t>_;)I(e,128|_&t),t=y(t/128);I(e,_&t)},T=(new Uint8Array(3e4).length,M&&M.encodeInto,(e,t)=>{const s=e.cbuf.length,r=e.cpos,i=(o=s-r)<(n=t.length)?o:n;var o,n;const d=t.length-i;e.cbuf.set(t.subarray(0,i),r),e.cpos+=i,d>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(((e,t)=>e>t?e:t)(2*s,d)),e.cbuf.set(t.subarray(i)),e.cpos=d)}),Y=(e,t)=>{W(e,t.byteLength),T(e,t)};new DataView(new ArrayBuffer(4));const E=(e,t,s)=>{W(e,1),Y(e,o.encodeStateAsUpdate(t,s))},U=(e,t,s)=>{try{o.applyUpdate(t,A(e),s)}catch(e){console.error("Caught error while handling a Yjs update",e)}},j=U;var O,x;!function(e){e[e.SYNC=0]="SYNC",e[e.AWARENESS=1]="AWARENESS"}(O||(O={}));class R{constructor(e){this._onMsg=e=>{if(e.buffers){const t=e.buffers[0],s=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t),r=x.readMessage(this,s,!0);S(r)>1&&this._sendOverComm(F(r))}},this._updateHandler=(e,t)=>{const s=D();W(s,O.SYNC),((e,t)=>{W(e,2),Y(e,t)})(s,e),this._sendOverComm(F(s))},this._isDisposed=!1,this._comm=e.comm,this._ydoc=e.ydoc,this._ydoc.on("update",this._updateHandler),this._connect()}get doc(){return this._ydoc}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._comm.close(),this._isDisposed=!0)}_connect(){this._sync(),this._comm.onMsg=this._onMsg}_sync(){const e=D();W(e,O.SYNC),((e,t)=>{W(e,0);const s=o.encodeStateVector(t);Y(e,s)})(e,this._ydoc),this._sendOverComm(F(e))}_sendOverComm(e){this._comm.send({},void 0,[e.buffer])}}!function(e){function t(e,t,s,r){W(e,O.SYNC);const i=((e,t,s,r)=>{const i=N(e);switch(i){case 0:((e,t,s)=>{E(t,s,A(e))})(e,t,s);break;case 1:U(e,s,r);break;case 2:j(e,s,r);break;default:throw new Error("Unknown message type")}return i})(t,e,s.doc,s);r&&1===i&&!s.synced&&(E(e,s.doc),s.synced=!0)}e.syncMessageHandler=t,e.readMessage=function(e,s,r){const i=new C(s),o=D();return N(i)===O.SYNC?t(o,i,e,r):console.error("Unable to compute message"),o}}(x||(x={}));class J{constructor(){this._registry=new Map,this._yModelFactories=new Map,this._yWidgetFactories=new Map}registerKernel(e){const t=this._yModelFactories,s=new K({kernel:e,yModelFactories:t});this._registry.set(e.id,s)}unregisterKernel(e){e&&this._registry.delete(e)}registerWidget(e,t,s){this._yModelFactories.set(e,t),this._yWidgetFactories.set(e,s)}getWidgetModel(e,t){var s;return null===(s=this._registry.get(e))||void 0===s?void 0:s.getModel(t)}getWidgetFactory(e){return this._yWidgetFactories.get(e)}}class K{constructor(e){this._handle_comm_open=async(e,t)=>{const s=new(this._yModelFactories.get(t.metadata.ymodel_name))(t.metadata);new R({comm:e,ydoc:s.sharedModel.ydoc}),this._yModels.set(e.commId,s)},this._yModels=new Map;const{kernel:t,yModelFactories:s}=e;this._yModelFactories=s,t.registerCommTarget("ywidget",this._handle_comm_open)}getModel(e){return this._yModels.get(e)}}const V={id:"jupyterywidget:notebookRenderer",autoStart:!0,requires:[c.IRenderMimeRegistry,a.INotebookTracker,l],activate:(e,t,s,r)=>{const i={safe:!0,mimeTypes:["application/vnd.jupyter.ywidget-view+json"],createRenderer:e=>{var t,i,o;const n=null===(o=null===(i=null===(t=s.currentWidget)||void 0===t?void 0:t.sessionContext.session)||void 0===i?void 0:i.kernel)||void 0===o?void 0:o.id,d=e.mimeType,a=new h({kernelId:n,widgetManager:r});return new u({mimeType:d,modelFactory:a})}};t.addFactory(i,-100)}},q={id:"yjs-widgets:yWidgetManagerPlugin",autoStart:!0,requires:[a.INotebookTracker],provides:l,activate:(e,t)=>{const s=new J,r=(e,t)=>{const{newValue:r,oldValue:i}=t;r&&(s.unregisterKernel(null==i?void 0:i.id),s.registerKernel(r),r.disposed.connect((()=>{s.unregisterKernel(r.id)})))};return t.widgetAdded.connect((async(e,t)=>{t.sessionContext.kernelChanged.connect(r),t.disposed.connect((()=>{t.sessionContext.kernelChanged.disconnect(r)}))})),s}},B=[V,q]}}]);