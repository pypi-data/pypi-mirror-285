(()=>{"use strict";var G={};async function k(){let e=null;const t=document.getElementById("otp_webauthn_config");if(t)return e=JSON.parse(t.innerText),Object.freeze(e);throw new Error("otp_webauthn_config element not found")}async function C(e){let t="";const n=e.csrfCookieName;if(document.cookie&&document.cookie!==""){const r=document.cookie.split(";");for(let a=0;a<r.length;a++){const c=r[a].trim();if(c.substring(0,n.length+1)===n+"="){t=decodeURIComponent(c.substring(n.length+1));break}}}return t}function f(e){const t=new Uint8Array(e);let n="";for(const a of t)n+=String.fromCharCode(a);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function I(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=(4-t.length%4)%4,r=t.padEnd(t.length+n,"="),a=atob(r),c=new ArrayBuffer(a.length),o=new Uint8Array(c);for(let g=0;g<a.length;g++)o[g]=a.charCodeAt(g);return c}function _(){return window?.PublicKeyCredential!==void 0&&typeof window.PublicKeyCredential=="function"}function P(e){const{id:t}=e;return{...e,id:I(t),transports:e.transports}}function v(e){return e==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(e)}class i extends Error{constructor({message:t,code:n,cause:r,name:a}){super(t,{cause:r}),this.name=a??r.name,this.code=n}}function N({error:e,options:t}){const{publicKey:n}=t;if(!n)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new i({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(n.authenticatorSelection?.requireResidentKey===!0)return new i({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(n.authenticatorSelection?.userVerification==="required")return new i({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new i({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new i({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return n.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new i({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new i({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const r=window.location.hostname;if(v(r)){if(n.rp.id!==r)return new i({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new i({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new i({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new i({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}class L{createNewAbortSignal(){if(this.controller){const n=new Error("Cancelling existing WebAuthn API call for new one");n.name="AbortError",this.controller.abort(n)}const t=new AbortController;return this.controller=t,t.signal}cancelCeremony(){if(this.controller){const t=new Error("Manually cancelling existing WebAuthn API call");t.name="AbortError",this.controller.abort(t),this.controller=void 0}}}const D=new L,K=["cross-platform","platform"];function O(e){if(e&&!(K.indexOf(e)<0))return e}async function U(e){if(!_())throw new Error("WebAuthn is not supported in this browser");const n={publicKey:{...e,challenge:I(e.challenge),user:{...e.user,id:I(e.user.id)},excludeCredentials:e.excludeCredentials?.map(P)}};n.signal=D.createNewAbortSignal();let r;try{r=await navigator.credentials.create(n)}catch(s){throw N({error:s,options:n})}if(!r)throw new Error("Registration was not completed");const{id:a,rawId:c,response:o,type:g}=r;let d;typeof o.getTransports=="function"&&(d=o.getTransports());let A;if(typeof o.getPublicKeyAlgorithm=="function")try{A=o.getPublicKeyAlgorithm()}catch(s){S("getPublicKeyAlgorithm()",s)}let R;if(typeof o.getPublicKey=="function")try{const s=o.getPublicKey();s!==null&&(R=f(s))}catch(s){S("getPublicKey()",s)}let w;if(typeof o.getAuthenticatorData=="function")try{w=f(o.getAuthenticatorData())}catch(s){S("getAuthenticatorData()",s)}return{id:a,rawId:f(c),response:{attestationObject:f(o.attestationObject),clientDataJSON:f(o.clientDataJSON),transports:d,publicKeyAlgorithm:A,publicKey:R,authenticatorData:w},type:g,clientExtensionResults:r.getClientExtensionResults(),authenticatorAttachment:O(r.authenticatorAttachment)}}function S(e,t){console.warn(`The browser extension that intercepted this WebAuthn API call incorrectly implemented ${e}. You should report this error to them.
`,t)}function x(){if(!_())return new Promise(t=>t(!1));const e=window.PublicKeyCredential;return e.isConditionalMediationAvailable===void 0?new Promise(t=>t(!1)):e.isConditionalMediationAvailable()}function B({error:e,options:t}){const{publicKey:n}=t;if(!n)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new i({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if(e.name==="NotAllowedError")return new i({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="SecurityError"){const r=window.location.hostname;if(v(r)){if(n.rpId!==r)return new i({message:`The RP ID "${n.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new i({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="UnknownError")return new i({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}async function F(e,t=!1){if(!_())throw new Error("WebAuthn is not supported in this browser");let n;e.allowCredentials?.length!==0&&(n=e.allowCredentials?.map(P));const r={...e,challenge:I(e.challenge),allowCredentials:n},a={};if(t){if(!await x())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete$='webauthn']").length<1)throw Error('No <input> with "webauthn" as the only or last value in its `autocomplete` attribute was detected');a.mediation="conditional",r.allowCredentials=[]}a.publicKey=r,a.signal=D.createNewAbortSignal();let c;try{c=await navigator.credentials.get(a)}catch(w){throw B({error:w,options:a})}if(!c)throw new Error("Authentication was not completed");const{id:o,rawId:g,response:d,type:A}=c;let R;return d.userHandle&&(R=f(d.userHandle)),{id:o,rawId:f(g),response:{authenticatorData:f(d.authenticatorData),clientDataJSON:f(d.clientDataJSON),signature:f(d.signature),userHandle:R},type:A,clientExtensionResults:c.getClientExtensionResults(),authenticatorAttachment:O(c.authenticatorAttachment)}}function q(){return _()?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable():new Promise(e=>e(!1))}(async function(){const e="passkey-register-button",t="passkey-register-status-message",n="visible",r="passkey-registration-placeholder",a="passkey-registration-unavailable-template",c="passkey-registration-available-template",o="otp_webauthn.register_start",g="otp_webauthn.register_complete",d="otp_webauthn.register_failed";async function A(s){const l=document.getElementById(e);if(!l)return;const b=l.textContent||gettext("Register a Passkey");l.addEventListener("click",async E=>{l.dispatchEvent(new CustomEvent(o,{bubbles:!0})),await u({buttonDisabled:!0,buttonLabel:gettext("Registering...")});const h=await fetch(s.beginRegistrationUrl,{method:"POST",credentials:"same-origin",headers:{"X-CSRFToken":await C(s),Accept:"application/json"}});if(!h.ok){u({buttonDisabled:!1,buttonLabel:b,requestFocus:!0,status:gettext("Registration failed. Unable to fetch registration options from server.")}),l.dispatchEvent(new CustomEvent(d,{detail:{response:h},bubbles:!0}));return}let p;try{p=await U(await h.json())}catch(m){if(console.error(m),m instanceof Error||m instanceof i){switch(m.name){case"AbortError":u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration aborted."),requestFocus:!0});break;case"InvalidStateError":u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration failed. You most likely already have a Passkey registered for this site."),requestFocus:!0});break;case"NotAllowedError":u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration aborted or not allowed."),requestFocus:!0});break;case"SecurityError":u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration failed. A technical problem occurred that prevents you from registering a Passkey for this site."),requestFocus:!0});break;default:throw u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration failed. An unknown error occurred."),requestFocus:!0}),m}l.dispatchEvent(new CustomEvent(d,{detail:{error:m},bubbles:!0}));return}}u({buttonDisabled:!0,buttonLabel:gettext("Finishing registration...")});const y=await fetch(s.completeRegistrationUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":await C(s)},credentials:"same-origin",body:JSON.stringify(p)});if(!y.ok){u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration failed. The server was unable to verify this passkey."),requestFocus:!0}),l.dispatchEvent(new CustomEvent(d,{detail:{response:y},bubbles:!0}));return}if(!y.headers.get("content-type")?.includes("application/json")){u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration failed. A server error occurred."),requestFocus:!0}),l.dispatchEvent(new CustomEvent(d,{detail:{response:y},bubbles:!0}));return}const T=await y.json();if(T&&T.id)u({buttonDisabled:!1,buttonLabel:b,status:gettext("Registration successful!"),requestFocus:!0}),l.dispatchEvent(new CustomEvent(g,{detail:{response:T,id:T.id},bubbles:!0}));else{const m=T.error||gettext("An error occurred during registration.");u({buttonDisabled:!1,buttonLabel:b,status:m,requestFocus:!0}),l.dispatchEvent(new CustomEvent(d,{detail:{response:y},bubbles:!0}))}});async function u(E){const h=document.getElementById(e);if(!h)return;const p=document.getElementById(t);h.disabled=E.buttonDisabled,h.textContent=E.buttonLabel,p&&(E.status?(h.setAttribute("aria-describedby",t),p.classList.add(n),p.textContent=E.status,p.setAttribute("aria-live","assertive"),E.requestFocus&&h.focus()):(h.removeAttribute("aria-describedby"),p.removeAttribute("aria-live"),p.classList.remove(n)))}}async function R(s){const l=document.getElementById(r),b=document.getElementById(c),u=document.getElementById(a);if(!l)throw new Error("Placeholder element not found");if(!b)throw new Error("Available template not found");if(s){const E=b.content.cloneNode(!0);l.replaceWith(E)}else if(u){const E=u.content.cloneNode(!0);l.replaceWith(E)}else l.remove()}const w=await k();if(_())await R(!0),await A(w);else{await R(!1);return}})()})();

//# sourceMappingURL=otp_webauthn_register.js.map