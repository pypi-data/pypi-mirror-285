import{V as _,x as y,y as $,W as F,_ as C,Z as p,aE as g,S as l,$ as s,aY as J,aq as O,bo as ee,X as w,l as A,Y as m,aG as k,aI as P,U as B,cM as oe,cN as te,cO as le,aM as W,bE as N,b1 as re,aO as t,al as se,aQ as R,aR as S,ak as d,cP as ae,bs as ne,aP as U,aF as ie,bS as H}from"./admin-drawer-panel-D_qGurp0.js";import{A as de,a as ce,b as me,c as G,R as ue}from"./relation-chips-DE08G87m.js";import{V as pe}from"./VCombobox-CLEC9nAk.js";import{V as E}from"./VCheckbox-BoSq-Gp8.js";import{V as he}from"./VTextField-DcZhRvPB.js";import{D as M}from"./datetime-column-C10LMvbg.js";import{C as fe}from"./confirm-dialog-CEegFOPy.js";import{u as be}from"./main-C_v3V6g9.js";import{V as z}from"./VCheckboxBtn-k69hHqz6.js";import{a as T,b as x,c as D,V}from"./VExpansionPanels-DSywtH47.js";import{V as ye}from"./VTable-CF4zd2t_.js";import"./VDialog-Dir_-l5o.js";import"./VSelect-cGleKlm7.js";import"./VSelectionControl-_6sv90xF.js";import"./VSlideGroup-DbQOqyzs.js";import"./filter-C96Ludgn.js";const _e={name:"AdminServerFolderPicker",emits:["change","menu"],data(){return{path:"",originalPath:"",showHidden:!1,menuOpen:!1}},computed:{..._(y,{folders:e=>e.folderPicker.folders,rootFolder:e=>e.folderPicker.rootFolder}),..._($,{formErrors:e=>e.form.errors}),appendOuterIcon(){return this.showHidden?this.mdiFolderHidden:this.mdiFolderOutline},showHiddenTooltipPrefix(){return this.showHidden?"Hide":"Show"}},watch:{menuOpen(e){e&&this.$emit("menu",e)}},created(){this.loadFolders().then(()=>(this.path=this.rootFolder,this.originalPath=this.rootFolder,!0)).catch(console.warn)},methods:{...F(y,["clearFolders","loadFolders"]),...F($,["clearErrors"]),change(e){const o=e?e.startsWith("/")||e.startsWith("\\")?e:[this.rootFolder,e].join("/"):this.rootFolder,a=this.menuOpen;this.clearErrors(),this.loadFolders(o,this.showHidden).then(()=>{this.menuOpen=a;let n="";return this.formErrors.length===0&&(this.path=n=this.rootFolder),this.$emit("change",n)}).catch(console.warn)},onBlur(){this.menuOpen=!1,this.change(this.path)},onClear(){this.clearFolders(this.orignalPath).then(()=>this.change(this.orginalPath)).catch(console.error)},onKeyDownEnter(){this.change(this.path)},onItemClick(e){this.change(e)}}},ve={id:"folderPicker"};function ge(e,o,a,n,r,u){return p(),g("div",ve,[l(pe,O({modelValue:r.path,"onUpdate:modelValue":o[0]||(o[0]=c=>r.path=c),menu:r.menuOpen,"onUpdate:menu":o[1]||(o[1]=c=>r.menuOpen=c)},e.$attrs,{"aria-label":"Library folder",clearable:"","error-messages":e.formErrors,"full-width":"","hide-details":"auto",items:e.folders,"menu-props":{maxHeight:"370px"},"validate-on":"blur",variant:"filled",onBlur:u.onBlur,"onClick:clear":u.onClear,onKeydown:ee(u.onKeyDownEnter,["enter"])}),{item:s(({item:c,props:f})=>[l(J,O(f,{title:c.title,value:c.value,onClick:v=>u.onItemClick(c.value)}),null,16,["title","value","onClick"])]),_:1},16,["modelValue","menu","error-messages","items","onBlur","onClick:clear","onKeydown"]),l(E,{modelValue:r.showHidden,"onUpdate:modelValue":o[2]||(o[2]=c=>r.showHidden=c),density:"compact",class:"showHidden","hide-details":"auto",label:"Show Hidden Folders"},null,8,["modelValue"])])}const we=C(_e,[["render",ge],["__scopeId","data-v-49f10642"]]),Ce={name:"TimeTextField",data(){return{FORMAT:"DDD HH:mm:SS",timeRules:[e=>/^\d{0,3}?[01]\d|2[0-3](?::[0-5]\d){2}$/.test(e)||`Invalid time format ${this.FORMAT}`]}}};function Ie(e,o,a,n,r,u){return p(),w(he,O({ref:"timeField",density:"compact",filled:"",hint:r.FORMAT,round:"",rules:r.timeRules},e.$attrs),null,16,["hint","rules"])}const ke=C(Ce,[["render",Ie]]),K=["events","poll","pollEvery","groups"];Object.freeze(K);const L={path:"",events:!0,poll:!0,pollEvery:"01:00:00",groups:[]};Object.freeze(L);const j=(e,o)=>(e=e.replaceAll("\\","/"),o=o.replaceAll("\\","/"),e.endsWith("/")||(e+="/"),o.endsWith("/")||(o+="/"),o.startsWith(e)),Fe={name:"AdminLibraryCreateUpdateInputs",components:{AdminRelationPicker:de,AdminServerFolderPicker:we,TimeTextField:ke},props:{oldRow:{type:[Object,Boolean],default:!1}},emits:["change"],data(){return{rules:{path:[e=>!!e||"Path is required",e=>{if(!e)return!1;for(const o of this.paths){if(j(o,e))return"Path is a child of an existing library";if(j(e,o))return"Path is a parent of an existing library"}return!0}]},row:A.cloneDeep(this.oldRow||L)}},computed:{..._(y,{groups:e=>e.groups,libraries:e=>e.libraries}),paths(){return this.nameSet(this.libraries,"path",this.oldRow,!1)}},watch:{row:{handler(e){this.$emit("change",e)},deep:!0},oldRow:{handler(e){this.row=A.cloneDeep(e)},deep:!0}},methods:{...F(y,["nameSet"])},UPDATE_KEYS:K,EMPTY_ROW:L},Ae={key:1};function Pe(e,o,a,n,r,u){const c=m("AdminServerFolderPicker"),f=m("TimeTextField"),v=m("AdminRelationPicker");return p(),g(B,null,[a.oldRow?(p(),g("div",Ae,k(a.oldRow.path),1)):(p(),w(c,{key:0,rules:r.rules.path,autofocus:"",label:"Library Folder",onChange:o[0]||(o[0]=h=>r.row.path=h)},null,8,["rules"])),l(E,{modelValue:r.row.events,"onUpdate:modelValue":o[1]||(o[1]=h=>r.row.events=h),"hide-details":"auto",hint:"Update Codex instantly when the filesystem changes",label:"Watch Filesystem Events","persistent-hint":!0},null,8,["modelValue"]),l(E,{modelValue:r.row.poll,"onUpdate:modelValue":o[2]||(o[2]=h=>r.row.poll=h),label:"Poll Filesystem Periodically","hide-details":"auto",hint:"Periodically poll the library for changes","persistent-hint":!0},null,8,["modelValue"]),l(f,{modelValue:r.row.pollEvery,"onUpdate:modelValue":o[3]||(o[3]=h=>r.row.pollEvery=h),label:"Poll Every",disabled:!r.row.poll},null,8,["modelValue","disabled"]),r.row.coversOnly?P("",!0):(p(),w(v,{key:2,modelValue:r.row.groups,"onUpdate:modelValue":o[4]||(o[4]=h=>r.row.groups=h),label:"Groups",objs:e.groups,"group-type":"","title-key":"name"},null,8,["modelValue","objs"]))],64)}const Y=C(Fe,[["render",Pe]]),Te={name:"AdminLibrariesTab",components:{AdminTable:ce,AdminDeleteRowDialog:me,AdminCreateUpdateDialog:G,RelationChips:ue,ConfirmDialog:fe,DateTimeColumn:M},props:{coversDir:{type:Boolean,default:!1}},data(){return{lastUpdate:{pk:0,field:void 0},mdiCircleOffOutline:oe,mdiDatabaseClockOutline:te,mdiDatabaseSyncOutline:le,mdiOpenInNew:W,AdminLibraryCreateUpdateInputs:N(Y)}},computed:{..._(y,{groups:e=>e.groups,items(e){const o=[];for(const a of e.libraries){const n=A.cloneDeep(a);n.label=n.coversOnly?"custom group cover":"comic",o.push(n)}return o},headers(){const e=[{title:"Path",key:"path",align:"start"},{title:"Watch File Events",key:"events"},{title:"Poll Files Periodically",key:"poll"},{title:"Poll Every",key:"pollEvery"},{title:"Last Poll",key:"lastPoll"}];return this.coversDir||e.push({title:"Groups",key:"groups"}),e.push({title:"Actions",key:"actions",sortable:!1}),e}}),..._($,{formErrors:e=>{var o;return(o=e.form)==null?void 0:o.errors}}),..._(be,{twentyFourHourTime:e=>e.settings.twentyFourHourTime})},mounted(){this.loadTables(["Group","Library","FailedImport"])},methods:{...F(y,["updateRow","clearErrors","librarianTask","loadTables"]),formatDateTime:e=>e?re(e,(void 0).twentyFourHourTime):"",changeCol(e,o,a){this.lastUpdate.pk=e,this.lastUpdate.field=o;const n={[o]:a};this.updateRow("Library",e,n)},getFormErrors(e,o){if(e===this.lastUpdate.pk&&o===this.lastUpdate.field)return this.formErrors},libraryLabel(e,o=!0){let a="";return e.coversOnly?(o&&(a+="Custom Group "),a+="Cover Dir"):a+="Library",a},poll(e){const o=this.libraryLabel(e);this.librarianTask("poll",`Poll ${o} ${e.pk}`,e.pk)},forcePoll(e){const o=this.libraryLabel(e);this.librarianTask("poll_force",`Force Poll ${o} ${e.pk}`,e.pk)},pollConfirmText(e){return`Poll ${this.libraryLabel(e,!1)}`},updateLabel(e){return e.coversOnly?"Cover Dir":""}}},xe=e=>(R("data-v-32d7dd7b"),e=e(),S(),e),De=xe(()=>t("td",{class:"adminNoData",colspan:"100%"}," Add a Library to start using Codex ",-1));function Ve(e,o,a,n,r,u){const c=m("DateTimeColumn"),f=m("RelationChips"),v=m("ConfirmDialog"),h=m("AdminCreateUpdateDialog"),Q=m("AdminDeleteRowDialog"),X=m("AdminTable");return p(),w(X,{headers:e.headers},{"no-data":s(()=>[De]),"item.events":s(({item:i})=>[l(z,{"model-value":i.events,disabled:""},null,8,["model-value"])]),"item.poll":s(({item:i})=>[l(z,{"model-value":i.poll,disabled:""},null,8,["model-value"])]),"item.pollEvery":s(({item:i})=>[t("span",{class:se({disabled:!i.poll})},k(i.pollEvery),3)]),"item.lastPoll":s(({item:i})=>[l(c,{dttm:i.lastPoll},null,8,["dttm"])]),"item.groups":s(({item:i})=>[l(f,{pks:i.groups,objs:e.groups,"group-type":"","title-key":"name"},null,8,["pks","objs"])]),"item.actions":s(({item:i})=>[l(v,{icon:r.mdiDatabaseClockOutline,"title-text":`Poll for updated ${i.label}s`,"object-name":i.path,"confirm-text":u.pollConfirmText(i),size:"small",density:"compact",onConfirm:Z=>u.poll(i)},null,8,["icon","title-text","object-name","confirm-text","onConfirm"]),l(v,{icon:r.mdiDatabaseSyncOutline,"title-text":`Force update every ${i.label}`,"object-name":i.path,"confirm-text":"Force Update",size:"small",density:"compact",onConfirm:Z=>u.forcePoll(i)},null,8,["icon","title-text","object-name","onConfirm"]),l(h,{table:"Library","old-row":i,inputs:r.AdminLibraryCreateUpdateInputs,label:u.updateLabel(i),"max-width":"22em",size:"small",density:"compact"},null,8,["old-row","inputs","label"]),i.coversOnly?P("",!0):(p(),w(Q,{key:0,table:"Library",pk:i.pk,name:i.path,size:"small",density:"compact"},null,8,["pk","name"]))]),_:2},1032,["headers"])}const q=C(Te,[["render",Ve],["__scopeId","data-v-32d7dd7b"]]),$e={name:"AdminCustomCoversPanel",components:{AdminLibraryTable:q},computed:{..._(y,{coverDirItems(e){const o=[];for(const a of e.libraries)if(a.coversOnly){const n=A.cloneDeep(a);n.label=n.coversOnly?"custom group cover":"comic",o.push(n)}return o}})}},b=e=>(R("data-v-695df62c"),e=e(),S(),e),Oe=b(()=>t("h4",{id:"coverDirHeader"},"Custom Covers",-1)),Ee=b(()=>t("h4",null,"Custom Covers Help",-1)),Le=b(()=>t("p",null,"Custom covers may be added to the browser in two locations:",-1)),Re=b(()=>t("h4",null,"Folders",-1)),Se=b(()=>t("p",null,[d(" A library folder with a file named "),t("code",null,".codex-cover.jpg"),d(" will show a custom cover for that folder in Folder view. The addition and removal of these covers by watching filesystem events and polling is handled by the library that folder belongs to. ")],-1)),Ue=b(()=>t("h4",null,"Custom Covers Dir",-1)),He=b(()=>t("p",null,[d(" The Codex config directory has a special folder named "),t("code",null,"custom-covers"),d(" under which are subdirectories for each of the browser groups that may adopt custom covers. Images in these subdirectories that match the name of the browser group will be used as custom covers. For instance: "),t("code",null,".../custom-covers/publishers/American Comics Group.webp"),d(' would be used as the cover for the publisher "American Comics Group". '),t("code",null,".../custom-covers/series/arrow.png"),d(' would be used as the cover for every series named "Arrow", for '),t("em",null,"every"),d(" publisher. Similar to a comic library, the "),t("code",null,"custom-covers"),d(" directory may be watched and polled for changes. By default it is neither watched nor polled and must be enabled by the admin. ")],-1)),ze=b(()=>t("h4",null,"Image Formats & Size",-1)),je=b(()=>t("p",null,[d(" Custom covers are detected only for files with the extensions: "),t("code",null,".bmp, .gif, .jpeg, .jpg, .png, .webp"),d(". ")],-1)),Be=b(()=>t("p",null," Browser covers are transformed from their sources to 165px x 254px thumbnails. Custom covers will transform most aesthetically the closer to that ratio they are. ",-1)),We=b(()=>t("h4",null,"Priority",-1)),Ne=b(()=>t("p",null," Custom covers supersede covers set by the user's individual browser settings. ",-1));function Ge(e,o,a,n,r,u){const c=m("AdminLibraryTable");return p(),w(D,null,{default:s(()=>[l(V,null,{default:s(()=>[l(T,null,{default:s(()=>[Oe]),_:1}),l(x,null,{default:s(()=>[l(c,{items:e.coverDirItems,"disable-sort":"","covers-dir":!0},null,8,["items"]),l(D,null,{default:s(()=>[l(V,{id:"customCoversHelp"},{default:s(()=>[l(T,null,{default:s(()=>[Ee]),_:1}),l(x,null,{default:s(()=>[Le,Re,Se,Ue,He,ze,je,Be,We,Ne]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const Me=C($e,[["render",Ge],["__scopeId","data-v-695df62c"]]),Ke={name:"AdminFailedImportsPanel",components:{DateTimeColumn:M},data(){return{mdiBookAlert:ae,mdiOpenInNew:W}},computed:{..._(y,["failedImports"]),...ne(y,["unseenFailedImports"])},created(){this.unseenFailedImports=!0}},I=e=>(R("data-v-a99d09dc"),e=e(),S(),e),Ye={key:0},qe=I(()=>t("thead",null,[t("tr",null,[t("th",null,"Path"),t("th",null,"Created")])],-1)),Qe={class:"dateCol"},Xe=I(()=>t("h4",null,"Failed Imports Help",-1)),Ze=I(()=>t("p",null," These are Comic archives that have failed to import. This list is updated every time the library updates. You should probably review these files and fix or remove them. ",-1)),Je=I(()=>t("h4",null,"Fixing comics",-1)),eo=I(()=>t("p",null,[d(" Try using the zip fixer to fix comics: "),t("code",{class:"cli"},[d(" cp problem-comic.cbz /somewhere/safe/problem-comic.cbz.backup"),t("br"),d(" zip -F problem-comic.cbz --out fixed.zip"),t("br"),d(" mv fixed.zip problem-comic.cbz ")]),d(" You may also try "),t("code",null,"zip -FF"),d(" to fix comics which uses a different (not necissarily better) algorithm. If you fix some imports, and Codex does not immediately detect the change, poll the library which contains the fixed comics. ")],-1)),oo=I(()=>t("h4",null,"Reporting Issues",-1)),to={href:"https://github.com/ajslater/codex/issues/",target:"_blank"},lo=I(()=>t("code",null,"config/logs/codex.log",-1));function ro(e,o,a,n,r,u){const c=m("DateTimeColumn");return e.failedImports&&e.failedImports.length>0?(p(),g("div",Ye,[l(D,null,{default:s(()=>[l(V,{id:"failedImportsPanel",onClick:o[0]||(o[0]=f=>e.unseenFailedImports=!1)},{default:s(()=>[l(T,null,{default:s(()=>[t("h4",null,"Failed Imports: "+k(e.failedImports.length),1),e.unseenFailedImports?(p(),w(U,{key:0,id:"failedImportsIcon",title:"New Failed Imports"},{default:s(()=>[d(k(r.mdiBookAlert),1)]),_:1})):P("",!0)]),_:1}),l(x,null,{default:s(()=>[l(ye,{class:"highlight-table"},{default:s(()=>[qe,t("tbody",null,[(p(!0),g(B,null,ie(e.failedImports,f=>(p(),g("tr",{key:`fi:${f.path}`},[t("td",null,k(f.path),1),t("td",Qe,[l(c,{dttm:f.createdAt},null,8,["dttm"])])]))),128))])]),_:1}),l(D,null,{default:s(()=>[l(V,{id:"failedImportsHelp"},{default:s(()=>[l(T,null,{default:s(()=>[Xe]),_:1}),l(x,null,{default:s(()=>[Ze,Je,eo,oo,t("p",null,[d(" If the comic looks good to you, but still shows up as a failed import, it might be Codex's fault for not importing it correctly. Please file an "),t("a",to,[d("Issue Report"),l(U,{size:"small"},{default:s(()=>[d(k(r.mdiOpenInNew),1)]),_:1})]),d(" and include the stack trace from the logs at "),lo,d(" if you can. ")])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])):P("",!0)}const so=C(Ke,[["render",ro],["__scopeId","data-v-a99d09dc"]]),ao={name:"AdminLibrariesTab",components:{AdminFailedImportsPanel:so,AdminLibraryTable:q,AdminCreateUpdateDialog:G,AdminCustomCoversPanel:Me},data(){return{AdminLibraryCreateUpdateInputs:N(Y)}},computed:{..._(y,{libraryItems(e){const o=[];if(!e.libraries)return o;for(const a of e.libraries)if(!a.coversOnly){const n=A.cloneDeep(a);n.label=n.coversOnly?"custom group cover":"comic",o.push(n)}return o}})},mounted(){this.loadTables(["Group","Library","FailedImport"])},methods:{...F(y,["loadTables"])}},no={class:"tabHeader"};function io(e,o,a,n,r,u){const c=m("AdminCreateUpdateDialog"),f=m("AdminLibraryTable"),v=m("AdminFailedImportsPanel"),h=m("AdminCustomCoversPanel");return p(),g("div",null,[t("header",no,[l(c,{table:"Library",inputs:r.AdminLibraryCreateUpdateInputs},null,8,["inputs"])]),l(f,{items:e.libraryItems,"sort-by":[{key:"path",order:"asc"}]},null,8,["items"]),l(H,null,{default:s(()=>[l(v,{id:"failedImports"})]),_:1}),l(H,null,{default:s(()=>[l(h,{id:"customCovers"})]),_:1})])}const Ao=C(ao,[["render",io],["__scopeId","data-v-b40f74f1"]]);export{Ao as default};
